// {
//   "name": "component-iconic-product-comparison.min.js",
//   "author": "Arham Web Works"
//   "description": "Copying in any form is strictly prohibited. Any instance of copying will be subject to legal action and accountability under the law."
// }

function scrollToAddToCart() {
  const addToCartForm = document.querySelector('form[action="/cart/add"]');
  
  if (addToCartForm) {
    addToCartForm.scrollIntoView({ 
      behavior: 'smooth', 
      block: 'center' 
    });
  }
}

// Initialize all product comparison sections on the page
(function() {
  'use strict';

  // Find all product comparison sections
  function initAllSections() {
    const sections = document.querySelectorAll('[data-iconic-product-comparison]');
    sections.forEach(function(sectionElement) {
      const sectionId = sectionElement.getAttribute('data-section-id');
      if (sectionId && !sectionElement.hasAttribute('data-comparison-initialized')) {
        sectionElement.setAttribute('data-comparison-initialized', 'true');
        initProductComparison(sectionId, sectionElement);
      }
    });
  }

  // Initialize a single product comparison section
  function initProductComparison(sectionId, sectionElement) {
    const sectionSelector = '#iconic-product-comparison-first-' + sectionId;
    
    const highlightDifferencesDefault = sectionElement.getAttribute('data-highlight-differences') === 'true';
    const colorMappingText = sectionElement.getAttribute('data-color-mapping') || '';
    
    initScrollShadows(sectionSelector);
    initComparisonFeatures(sectionSelector, highlightDifferencesDefault);
    initColorSwatches(sectionSelector, colorMappingText);
  }

  // ============================================================================
  // SCROLL SHADOWS
  // Fallback for browsers without scroll-driven animations
  // ============================================================================
  function initScrollShadows(sectionSelector) {
    const supportsScrollTimeline = CSS.supports('animation-timeline', 'scroll()');
    
    if (supportsScrollTimeline) return;
    
    function setupScrollShadows() {
      const section = document.querySelector(sectionSelector);
      if (!section) return;
      
      const tableWrappers = section.querySelectorAll('.iconic-compare-products-table-wrapper');
      
      tableWrappers.forEach(function(wrapper) {
        // Skip if already initialized
        if (wrapper.hasAttribute('data-scroll-shadow-initialized')) return;
        wrapper.setAttribute('data-scroll-shadow-initialized', 'true');
        
        const table = wrapper.querySelector('.iconic-compare-products-table');
        if (!table) return;
        
        // Create shadow elements if they don't exist
        let rightShadow = wrapper.querySelector('.iconic-scroll-shadow-right');
        let leftShadow = wrapper.querySelector('.iconic-scroll-shadow-left');
        
        if (!rightShadow) {
          rightShadow = document.createElement('div');
          rightShadow.className = 'iconic-scroll-shadow-right';
          rightShadow.style.cssText = 'position: absolute; top: 0; right: 0; width: 15px; height: 100%; pointer-events: none; background: linear-gradient(90deg, rgba(0, 0, 0, 0.08), rgba(0, 0, 0, 0.05) 30%, transparent); opacity: 0; transition: opacity 0.3s ease; z-index: 10;';
          wrapper.style.position = 'relative';
          wrapper.appendChild(rightShadow);
        }
        
        if (!leftShadow) {
          leftShadow = document.createElement('div');
          leftShadow.className = 'iconic-scroll-shadow-left';
          leftShadow.style.cssText = 'position: absolute; top: 0; left: 0; width: 15px; height: 100%; pointer-events: none; background: linear-gradient(270deg, rgba(0, 0, 0, 0.08), rgba(0, 0, 0, 0.05) 30%, transparent); opacity: 0; transition: opacity 0.3s ease; z-index: 10;';
          wrapper.appendChild(leftShadow);
        }
        
        function updateShadows() {
          const scrollLeft = wrapper.scrollLeft;
          const scrollWidth = wrapper.scrollWidth;
          const clientWidth = wrapper.clientWidth;
          const maxScroll = scrollWidth - clientWidth;
          
          // Only show shadows if scrolling is possible
          if (maxScroll <= 0) {
            rightShadow.style.opacity = '0';
            leftShadow.style.opacity = '0';
            return;
          }
          
          // Show right shadow when scrolled from the start
          if (scrollLeft > 0.5) {
            rightShadow.style.opacity = '1';
          } else {
            rightShadow.style.opacity = '0';
          }
          
          // Show left shadow when not scrolled to the end
          if (scrollLeft < maxScroll - 0.5) {
            leftShadow.style.opacity = '1';
          } else {
            leftShadow.style.opacity = '0';
          }
        }
        
        // Update on scroll
        wrapper.addEventListener('scroll', updateShadows, { passive: true });
        
        // Update on resize
        const resizeObserver = new ResizeObserver(updateShadows);
        resizeObserver.observe(wrapper);
        resizeObserver.observe(table);
        
        // Initial update
        updateShadows();
      });
    }
    
    // Initialize on load
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', function() {
        setTimeout(setupScrollShadows, 100);
        setTimeout(setupScrollShadows, 500);
        setTimeout(setupScrollShadows, 1500);
      });
    } else {
      setTimeout(setupScrollShadows, 100);
      setTimeout(setupScrollShadows, 500);
      setTimeout(setupScrollShadows, 1500);
    }
    
    // Watch for section visibility
    const section = document.querySelector(sectionSelector);
    if (section) {
      const observer = new MutationObserver(function() {
        setTimeout(setupScrollShadows, 100);
      });
      observer.observe(section, {
        childList: true,
        subtree: true,
        attributes: true,
        attributeFilter: ['style', 'class']
      });
    }
  }

  // ============================================================================
  // COMPARISON FEATURES
  // Highlight differences, show all rows functionality
  // ============================================================================
  function initComparisonFeatures(sectionSelector, highlightDifferencesDefault) {
    let highlightDifferences = highlightDifferencesDefault;
    
    // Function to get current highlight state from checkbox
    function getHighlightState() {
      const section = document.querySelector(sectionSelector);
      if (!section) return highlightDifferences;
      
      const checkbox = section.querySelector('.iconic-highlight-differences-checkbox');
      if (checkbox) {
        return checkbox.checked;
      }
      return highlightDifferences;
    }
    
    function normalizeText(text) {
      if (!text) return '';
      return text.toString().trim().toLowerCase().replace(/\s+/g, ' ').replace(/[^\w\s]/g, '');
    }
    
    function extractPrice(text) {
      if (!text) return '';
      const match = text.toString().match(/[\d,]+\.?\d*/);
      return match ? match[0].replace(/,/g, '') : '';
    }
    
    function getCellValue(cell) {
      const clone = cell.cloneNode(true);
      const mobileTitles = clone.querySelectorAll('.iconic-table-title-mobile');
      mobileTitles.forEach(function(title) {
        title.remove();
      });
      
      const buttons = clone.querySelectorAll('button, .iconic-btn, a');
      buttons.forEach(function(btn) {
        btn.remove();
      });
      
      let text = clone.textContent || clone.innerText || '';
      text = text.trim();
      
      const priceData = cell.getAttribute('data-price');
      if (priceData) {
        const priceValue = extractPrice(text);
        return priceValue || normalizeText(text);
      }
      
      const checkIcon = cell.querySelector('.bi-check, [class*="bi-check"]');
      const xIcon = cell.querySelector('.bi-x, [class*="bi-x"]');
      if (checkIcon) return 'check';
      if (xIcon) return 'uncheck';
      
      if (cell.querySelector('.iconic-stock-in')) return 'stock-in';
      if (cell.querySelector('.iconic-stock-out')) return 'stock-out';
      if (cell.querySelector('.iconic-stock-low')) return 'stock-low';
      
      return normalizeText(text);
    }
    
    function checkRowDifferences(row) {
      const shouldHighlight = getHighlightState();
      if (!shouldHighlight) {
        row.classList.remove('iconic-row-different');
        row.classList.remove('iconic-row-same');
        return;
      }
      
      const cells = row.querySelectorAll('td:not(:first-child)');
      if (cells.length < 2) {
        row.classList.remove('iconic-row-different');
        row.classList.remove('iconic-row-same');
        return;
      }
      
      const values = Array.from(cells).map(getCellValue);
      const firstValue = values[0];
      const allSame = values.every(function(val) {
        return val === firstValue;
      });
      
      if (!allSame) {
        row.classList.add('iconic-row-different');
        row.classList.remove('iconic-row-same');
      } else {
        row.classList.add('iconic-row-same');
        row.classList.remove('iconic-row-different');
      }
    }
    
    function updateShowAllButtonVisibility() {
      const section = document.querySelector(sectionSelector);
      if (!section) return;
      
      const shouldHighlight = getHighlightState();
      const buttons = section.querySelectorAll('.iconic-show-all-rows-btn');
      
      buttons.forEach(function(button) {
        let table = null;
        const wrapper = button.previousElementSibling;
        
        if (wrapper && wrapper.classList.contains('iconic-compare-products-table-wrapper')) {
          table = wrapper.querySelector('.iconic-compare-products-table');
        }
        
        if (!table) {
          let sibling = button.previousElementSibling;
          while (sibling && !table) {
            table = sibling.querySelector('.iconic-compare-products-table');
            if (!table) {
              sibling = sibling.previousElementSibling;
            }
          }
        }
        
        if (!table) {
          const tables = section.querySelectorAll('.iconic-compare-products-table');
          table = tables[tables.length - 1];
        }
        
        if (!table) return;
        
        const allRows = table.querySelectorAll('tbody tr');
        const totalRows = allRows.length;
        
        if (shouldHighlight) {
          let visibleRowCount = 0;
          allRows.forEach(function(row) {
            const isHidden = row.classList.contains('iconic-row-hidden');
            const isSame = row.classList.contains('iconic-row-same');
            if (!isHidden && !isSame) {
              visibleRowCount++;
            }
          });
          
          if (visibleRowCount <= 10) {
            button.classList.add('hidden');
            if (wrapper && wrapper.classList.contains('iconic-compare-products-table-wrapper')) {
              wrapper.classList.remove('has-show-all-btn');
            }
          } else {
            button.classList.remove('hidden');
            if (wrapper && wrapper.classList.contains('iconic-compare-products-table-wrapper')) {
              wrapper.classList.add('has-show-all-btn');
            }
            const isShowingAll = button.getAttribute('data-show-all') === 'false';
            if (!isShowingAll) {
              button.textContent = 'Show All (' + visibleRowCount + ' rows)';
            }
          }
        } else {
          if (totalRows > 10) {
            button.classList.remove('hidden');
            if (wrapper && wrapper.classList.contains('iconic-compare-products-table-wrapper')) {
              wrapper.classList.add('has-show-all-btn');
            }
            const isShowingAll = button.getAttribute('data-show-all') === 'false';
            if (!isShowingAll) {
              button.textContent = 'Show All (' + totalRows + ' rows)';
            }
          } else {
            button.classList.add('hidden');
            if (wrapper && wrapper.classList.contains('iconic-compare-products-table-wrapper')) {
              wrapper.classList.remove('has-show-all-btn');
            }
          }
        }
        
        updateWrapperClasses();
      });
    }
    
    function highlightAllDifferences() {
      const section = document.querySelector(sectionSelector);
      if (!section) return;
      
      const shouldHighlight = getHighlightState();
      
      const tables = section.querySelectorAll('.iconic-compare-products-table');
      tables.forEach(function(table) {
        const rows = table.querySelectorAll('tbody tr');
        rows.forEach(function(row) {
          if (shouldHighlight) {
            checkRowDifferences(row);
          } else {
            row.classList.remove('iconic-row-different');
            row.classList.remove('iconic-row-same');
          }
        });
      });
      
      updateShowAllButtonVisibility();
      
      const wrappers = section.querySelectorAll('.iconic-compare-products-table-wrapper.has-show-all-btn');
      wrappers.forEach(function(wrapper) {
        markLastVisibleRow(wrapper);
      });
    }
    
    function initHighlightCheckbox() {
      const section = document.querySelector(sectionSelector);
      if (!section) return;
      
      const checkboxes = section.querySelectorAll('.iconic-highlight-differences-checkbox');
      checkboxes.forEach(function(checkbox) {
        // Skip if already initialized
        if (checkbox.hasAttribute('data-checkbox-initialized')) return;
        checkbox.setAttribute('data-checkbox-initialized', 'true');
        
        checkbox.addEventListener('change', function() {
          const isChecked = this.checked;
          highlightDifferences = isChecked;
          
          checkboxes.forEach(function(cb) {
            cb.checked = isChecked;
          });
          
          highlightAllDifferences();
          setTimeout(updateShowAllButtonVisibility, 100);
        });
      });
    }
    
    // Function to update wrapper classes based on button visibility
    function updateWrapperClasses() {
      const section = document.querySelector(sectionSelector);
      if (!section) return;
      
      const buttons = section.querySelectorAll('.iconic-show-all-rows-btn');
      buttons.forEach(function(button) {
        const wrapper = button.previousElementSibling;
        if (wrapper && wrapper.classList.contains('iconic-compare-products-table-wrapper')) {
          if (button.classList.contains('hidden')) {
            wrapper.classList.remove('has-show-all-btn');
            // Remove last visible row class when button is hidden
            const table = wrapper.querySelector('.iconic-compare-products-table');
            if (table) {
              const rows = table.querySelectorAll('tbody tr');
              rows.forEach(function(row) {
                row.classList.remove('iconic-last-visible-row');
              });
            }
          } else {
            wrapper.classList.add('has-show-all-btn');
            markLastVisibleRow(wrapper);
          }
        }
      });
    }
    
    function markLastVisibleRow(wrapper) {
      if (!wrapper) return;
      
      const table = wrapper.querySelector('.iconic-compare-products-table');
      if (!table) return;
      
      const rows = Array.from(table.querySelectorAll('tbody tr'));
      
      const shouldHighlight = getHighlightState();
      let lastVisibleRow = null;
      let currentLastRow = null;
      
      rows.forEach(function(row) {
        if (row.classList.contains('iconic-last-visible-row')) {
          currentLastRow = row;
        }
      });
      
      for (let i = rows.length - 1; i >= 0; i--) {
        const row = rows[i];
        const isHidden = row.classList.contains('iconic-row-hidden');
        const isSame = shouldHighlight && row.classList.contains('iconic-row-same');
        
        if (!isHidden && !isSame) {
          lastVisibleRow = row;
          break;
        }
      }
      
      if (lastVisibleRow !== currentLastRow) {
        if (currentLastRow) {
          currentLastRow.classList.remove('iconic-last-visible-row');
        }
        
        if (lastVisibleRow) {
          lastVisibleRow.classList.add('iconic-last-visible-row');
        }
      }
    }
    
    function initShowAllRows() {
      const section = document.querySelector(sectionSelector);
      if (!section) return;
      
      const buttons = section.querySelectorAll('.iconic-show-all-rows-btn');
      
      buttons.forEach(function(button) {
        if (button.hasAttribute('data-initialized')) return;
        button.setAttribute('data-initialized', 'true');
        
        let table = null;
        const wrapper = button.previousElementSibling;
        
        if (wrapper && wrapper.classList.contains('iconic-compare-products-table-wrapper')) {
          table = wrapper.querySelector('.iconic-compare-products-table');
        }
        
        if (!table) {
          let sibling = button.previousElementSibling;
          while (sibling && !table) {
            table = sibling.querySelector('.iconic-compare-products-table');
            if (!table) {
              sibling = sibling.previousElementSibling;
            }
          }
        }
        
        if (!table) {
          const tables = section.querySelectorAll('.iconic-compare-products-table');
          table = tables[tables.length - 1];
        }
        
        if (!table) {
          console.warn('Could not find table for show all rows button');
          return;
        }
        
        const allRows = table.querySelectorAll('tbody tr');
        const totalRows = allRows.length;
        
        button.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          
          const isShowingAll = this.getAttribute('data-show-all') === 'true';
          const rows = Array.from(allRows);
          
          const buttonWrapper = button.previousElementSibling;
          const isWrapper = buttonWrapper && buttonWrapper.classList.contains('iconic-compare-products-table-wrapper');
          
          if (isShowingAll) {
            rows.forEach(function(row) {
              row.classList.remove('iconic-row-hidden');
            });
            this.textContent = 'Show Less';
            this.setAttribute('data-show-all', 'false');
          } else {
            rows.forEach(function(row, index) {
              if (index >= 10) {
                row.classList.add('iconic-row-hidden');
              }
            });
            this.textContent = 'Show All (' + totalRows + ' rows)';
            this.setAttribute('data-show-all', 'true');
          }
          
          if (isWrapper) {
            markLastVisibleRow(buttonWrapper);
          }
          
          setTimeout(function() {
            highlightAllDifferences();
            updateShowAllButtonVisibility();
            updateWrapperClasses();
            if (isWrapper) {
              markLastVisibleRow(buttonWrapper);
            }
          }, 100);
        });
      });
    }
    
    function init() {
      const section = document.querySelector(sectionSelector);
      if (!section) return;
      
      const isVisible = section.offsetParent !== null || 
                        window.getComputedStyle(section).display !== 'none';
      if (!isVisible) {
        setTimeout(init, 300);
        return;
      }
      
      initHighlightCheckbox();
      initShowAllRows();
      highlightAllDifferences();
      setTimeout(function() {
        updateShowAllButtonVisibility();
        updateWrapperClasses();
        const wrappers = section.querySelectorAll('.iconic-compare-products-table-wrapper.has-show-all-btn');
        wrappers.forEach(function(wrapper) {
          markLastVisibleRow(wrapper);
        });
      }, 100);
    }
    
    // Watch for section visibility changes
    function watchSectionVisibility() {
      const section = document.querySelector(sectionSelector);
      if (!section) return;
      
      const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
          if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
            const isVisible = section.offsetParent !== null || 
                              window.getComputedStyle(section).display !== 'none';
            if (isVisible) {
              setTimeout(init, 100);
            }
          }
        });
      });
      
      observer.observe(section, {
        attributes: true,
        attributeFilter: ['style', 'class']
      });
    }
    
    // Run initialization
    function runInit() {
      watchSectionVisibility();
      init();
      
      const delays = [500, 1500, 3000];
      delays.forEach(function(delay) {
        setTimeout(function() {
          init();
          updateWrapperClasses();
          const section = document.querySelector(sectionSelector);
          if (section) {
            const wrappers = section.querySelectorAll('.iconic-compare-products-table-wrapper.has-show-all-btn');
            wrappers.forEach(function(wrapper) {
              markLastVisibleRow(wrapper);
            });
          }
        }, delay);
      });
    }
    
    // Run on page load
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', runInit);
    } else {
      runInit();
    }
    
    // Watch for changes in the recommendations section
    const recommendationsElement = document.querySelector(sectionSelector + ' product-recommendations');
    if (recommendationsElement) {
      const observer = new MutationObserver(function(mutations) {
        let shouldCheck = false;
        mutations.forEach(function(mutation) {
          if (mutation.addedNodes.length > 0) {
            shouldCheck = true;
          }
        });
        if (shouldCheck) {
          setTimeout(init, 200);
        }
      });
      
      observer.observe(recommendationsElement, {
        childList: true,
        subtree: true
      });
    }
  }

  // ============================================================================
  // COLOR SWATCHES
  // Convert color names to hex codes
  // ============================================================================
  function initColorSwatches(sectionSelector, colorMappingText) {
    function parseColorMapping() {
      const colorMap = {};
      
      if (!colorMappingText || colorMappingText.trim() === '') {
        return colorMap;
      }
      
      const lines = colorMappingText.split('\n');
      
      lines.forEach(function(line) {
        line = line.trim();
        if (!line) return;
        
        const separator = line.includes(':') ? ':' : (line.includes(',') ? ',' : null);
        if (!separator) return;
        
        const parts = line.split(separator);
        if (parts.length >= 2) {
          const colorName = parts[0].trim().toLowerCase().replace(/\s+/g, '');
          const hexCode = parts[1].trim();
          
          if (/^#[0-9a-f]{6}$/i.test(hexCode) || /^[0-9a-f]{6}$/i.test(hexCode)) {
            const finalHex = hexCode.startsWith('#') ? hexCode : '#' + hexCode;
            colorMap[colorName] = finalHex;
          }
        }
      });
      
      return colorMap;
    }
    
    const colorMap = parseColorMapping();
    function getColorHex(colorName) {
      if (!colorName) return null;
      
      const normalized = colorName.toLowerCase().trim().replace(/\s+/g, '');
      
      if (colorMap[normalized]) {
        return colorMap[normalized];
      }
      
      for (const [key, hex] of Object.entries(colorMap)) {
        if (normalized.includes(key) || key.includes(normalized)) {
          return hex;
        }
      }
      
      if (/^#[0-9a-f]{6}$/i.test(normalized)) {
        return normalized;
      }
      
      // Try CSS color name
      const tempDiv = document.createElement('div');
      tempDiv.style.color = normalized;
      document.body.appendChild(tempDiv);
      const computedColor = window.getComputedStyle(tempDiv).color;
      document.body.removeChild(tempDiv);
      
      if (computedColor && computedColor !== 'rgb(0, 0, 0)' && computedColor !== 'rgba(0, 0, 0, 0)') {
        const rgb = computedColor.match(/\d+/g);
        if (rgb && rgb.length >= 3) {
          return '#' + rgb.slice(0, 3).map(function(x) {
            const hex = parseInt(x).toString(16);
            return hex.length === 1 ? '0' + hex : hex;
          }).join('');
        }
      }
      
      return null;
    }
    
    function enhanceColorSwatches() {
      const section = document.querySelector(sectionSelector);
      if (!section) return;
      
      const swatchCircles = section.querySelectorAll('.iconic-color-swatch-circle');
      
      swatchCircles.forEach(function(circle) {
        const colorName = circle.getAttribute('data-color');
        const currentBg = circle.style.backgroundColor;
        
        if (!currentBg || currentBg === 'transparent' || currentBg === 'rgba(0, 0, 0, 0)') {
          const hexColor = getColorHex(colorName);
          if (hexColor) {
            circle.style.backgroundColor = hexColor;
          } else {
            circle.style.backgroundColor = colorName;
          }
        }
      });
    }
    
    // Initialize on load
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', function() {
        setTimeout(enhanceColorSwatches, 100);
        setTimeout(enhanceColorSwatches, 500);
        setTimeout(enhanceColorSwatches, 1500);
      });
    } else {
      setTimeout(enhanceColorSwatches, 100);
      setTimeout(enhanceColorSwatches, 500);
      setTimeout(enhanceColorSwatches, 1500);
    }
    
    // Watch for section changes
    const section = document.querySelector(sectionSelector);
    if (section) {
      const observer = new MutationObserver(function() {
        setTimeout(enhanceColorSwatches, 100);
      });
      observer.observe(section, {
        childList: true,
        subtree: true
      });
    }
  }

  // ============================================================================
  // INITIALIZATION
  // ============================================================================
  
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initAllSections);
  } else {
    initAllSections();
  }
  
  const bodyObserver = new MutationObserver(function(mutations) {
    let shouldCheck = false;
    mutations.forEach(function(mutation) {
      if (mutation.addedNodes.length > 0) {
        mutation.addedNodes.forEach(function(node) {
          if (node.nodeType === 1 && (
            node.hasAttribute && node.hasAttribute('data-iconic-product-comparison') ||
            node.querySelector && node.querySelector('[data-iconic-product-comparison]')
          )) {
            shouldCheck = true;
          }
        });
      }
    });
    if (shouldCheck) {
      setTimeout(initAllSections, 100);
    }
  });
  
  bodyObserver.observe(document.body, {
    childList: true,
    subtree: true
  });
})();